{% extends "base.html" %}

{% block title %}产品查询 - 电商产品管理系统{% endblock %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-search"></i> 产品查询</h2>
</div>

<style>
    /* 可选：基础表格样式 */
    table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: center;
    }
    th {
        background-color: #f2f2f2;
        font-weight: bold;
    }
    tr:hover {
        background-color: #f5f5f5;
    }
</style>

<!-- 搜索和筛选表单 -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-4">
                <label for="search" class="form-label">搜索产品</label>
                <input type="text" class="form-control" id="search" name="search" value="{{ search_term }}" placeholder="产品名称、短名称或SKU">
            </div>
            <div class="col-md-3">
                <label for="category" class="form-label">分类</label>
                <select class="form-select" id="category" name="category">
                    <option value="">所有分类</option>
                    {% for category in categories %}
                    <option value="{{ category }}" {% if category == category %}selected{% endif %}>{{ category }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="submit" class="form-label">&nbsp;</label>
                <div>
                    <button type="submit" class="btn btn-primary me-2">搜索</button>
                    <a href="{{ url_for('products') }}" class="btn btn-outline-secondary">重置</a>
                </div>
            </div>
            <div class="col-md-2">
                <label for="add_product" class="form-label">&nbsp;</label>
                <div>
                    <a href="{{ url_for('add_product') }}" class="btn btn-success w-100">新增产品</a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- 产品列表 - 卡片布局 -->
<div class="row">
    {% if products_with_images %}
        {% for item in products_with_images %}
        {% set product = item.product %}
        {% set product_images = item.images %}
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <!-- 产品图片 -->
                <div class="card-img-top">
                    {% if product_images %}
                        <img src="{{ url_for('uploaded_file', filename=product_images[0].image_url, product_uid = product.uid) }}" class="card-img-top img-fluid" alt="{{ product.name }}" style="height: 200px; object-fit: cover;">
                    {% else %}
                        <div class="d-flex align-items-center justify-content-center" style="height: 200px; background-color: #f8f9fa; color: #6c757d;">
                            <span class="fs-6">暂无图片</span>
                        </div>
                    {% endif %}
                </div>
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">{{ product.name }}</h5>
                    {% if product.short_name %}
                        <p class="card-text"><strong>名称：</strong>{{ product.name }}</p>
                    {% endif %}
                    <p class="card-text"><strong>SKU：</strong>{{ product.sku }}</p>
                    <p class="card-text"><strong>成本：</strong>¥{{ "%.2f"|format(product.cost) }}</p>
                    <p class="card-text">
                        <button type="button" class="btn btn-success btn-sm">
                            <a class="av-link" href="{{ url_for('product_links')}}?product_uid={{ product.uid }}" target="_blank" style="color: white; text-decoration: none;">已上架链接({{ product_link_count[product.uid] or '0'}}条)</a>
                        </button>
                    </p>
                    <p class="card-text"><strong>开发者：</strong>{{ product.developer_username }}</p>

                    <!-- 操作按钮 -->
                    <div class="mt-auto">
                        <!-- 查看详情按钮，触发模态框 -->
                        <button type="button" class="btn btn-info btn-sm me-2" data-bs-toggle="modal" data-bs-target="#detailModal{{ loop.index }}">
                            <i class="fas fa-eye"></i> 查看详情
                        </button>
                        <!-- 修改按钮，链接到编辑产品页面 -->
                        {% if session.is_admin or product.developer_id == session.user_id %}
                        <a href="{{ url_for('edit_product', uid=product.uid) }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-edit"></i> 修改
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <!-- 添加图片模态框 -->
        <div class="modal fade" id="addImageModal{{ product.uid }}" tabindex="-1" aria-labelledby="addImageModalLabel{{ product.uid }}" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addImageModalLabel{{ product.uid }}">添加图片</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="uploadForm1" action="{{ url_for('add_image', product_uid=product.uid) }}" method="post" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="images" class="form-label">选择图片</label>
                                <input type="file" class="form-control" id="images" name="images" multiple accept="image/*" required>
                                <small class="text-muted">可选择多张图片</small>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">取消</button>
                                <button type="submit" class="btn btn-primary">上传图片</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- 加载中模态框 -->
        <div class="modal fade" id="loadingModal1" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
          <div class="modal-dialog modal-sm">
            <div class="modal-content">
              <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">上传中...</span>
                </div>
                <p class="mt-2">正在上传图片，请稍候...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- 添加附件模态框 -->
        <div class="modal fade" id="addFileModal{{ product.uid }}" tabindex="-1" aria-labelledby="addFileModalLabel{{ product.uid }}" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addFileModalLabel{{ product.uid }}">添加模型文件</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="uploadForm2" action="{{ url_for('upload_attachment', product_uid=product.uid) }}" method="post" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="file" class="form-label">选择模型文件</label>
                                <input type="file" class="form-control" id="file" name="file" multiple accept="file/*" required>
                                <small class="text-muted">可选择多个文件</small>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">取消</button>
                                <button type="submit" class="btn btn-primary">上传文件</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- 加载中模态框 -->
        <div class="modal fade" id="loadingModal2" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
          <div class="modal-dialog modal-sm">
            <div class="modal-content">
              <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">上传中...</span>
                </div>
                <p class="mt-2">正在上传文件，请稍候...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- 新增链接模态框 -->
        <div class="modal fade" id="addLinkModal{{ product.uid }}" tabindex="-1" aria-labelledby="addLinkModalLabel{{ product.uid }} aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addLinkModalLabel{{ product.uid }}">新增链接</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- 表单 -->
                        <form action="{{ url_for('add_link') }}" method="post">
                            <!-- 隐藏字段：当前产品的 UID -->
                            <input type="hidden" name="product_uid" value="{{ product.uid }}">


                            <div class="mb-3">
                                <label for="platform" class="form-label">平台 *</label>
                                <input type="text" class="form-control" id="platform" name="platform" required>
                            </div>
                            <div class="mb-3">
                                <label for="shop" class="form-label">店铺 *</label>
                                <input type="text" class="form-control" id="shop" name="shop" required>
                            </div>
                            <div class="mb-3">
                                <label for="listing_time" class="form-label">上架时间 *</label>
                                <input type="datetime-local" class="form-control" id="listing_time" name="listing_time" value="{{ current_time }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="title" class="form-label">标题 *</label>
                                <input type="text" class="form-control" id="title" name="title" required>
                            </div>
                            <div class="mb-3">
                                <label for="link_type" class="form-label">链接类型 *</label>
                                <input type="text" class="form-control" id="link_type" name="link_type" required>
                            </div>
                            <div class="mb-3">
                                <label for="price_type" class="form-label">价格类型 *</label>
                                <select class="form-control" id="price_type" name="price_type" required>
                                    <option value="supply">供应价</option>
                                    <option value="sale">销售价</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="price" class="form-label">价格 *</label>
                                <input type="number" step="0.01" class="form-control" id="price" name="price" required>
                            </div>
                            <div class="mb-3">
                                <label for="platform_skc" class="form-label">平台 SPU *</label>
                                <input type="text" class="form-control" id="platform_skc" name="platform_skc" required>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">取消</button>
                                <button type="submit" class="btn btn-primary">提交</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 新增包装规格模态框 -->
        <div class="modal fade" id="addPackageModal{{ product.uid }}" tabindex="-1" aria-labelledby="addPackageModalLabel{{ product.uid }} aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addPackageModalLabel{{ product.uid }}">新增包装规格</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- 表单 -->
                        <form action="{{ url_for('add_packages') }}" method="post">
                            <!-- 隐藏字段：当前产品的 UID -->
                            <input type="hidden" name="product_uid" value="{{ product.uid }}">


                            <div class="mb-3">
                                <label for="length" class="form-label">长(cm) *</label>
                                <input type="number" step="0.01" class="form-control" id="length" name="length" required>
                            </div>
                            <div class="mb-3">
                                <label for="width" class="form-label">宽(cm) *</label>
                                <input type="number" step="0.01" class="form-control" id="width" name="width" required>
                            </div>
                            <div class="mb-3">
                                <label for="height" class="form-label">高(cm) *</label>
                                <input type="number" step="0.01" class="form-control" id="height" name="height" required>
                            </div>
                            <div class="mb-3">
                                <label for="weight" class="form-label">带包装重量(g) *</label>
                                <input type="number" step="0.01" class="form-control" id="weight" name="weight" required>
                            </div>
                            <div class="mb-3">
                                <label for="description" class="form-label">描述 *</label>
                                <input type="text" class="form-control" id="description" name="description" required value="默认规格">
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">取消</button>
                                <button type="submit" class="btn btn-primary">提交</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 查看所有包装规格模态框 -->
        <div class="modal fade" id="showPackageModal{{ product.uid }}" tabindex="-1" aria-labelledby="showPackageModalLabel{{ product.uid }} aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="showPackageModalLabel{{ product.uid }}">{{ product.name}}的所有包装规格</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        {% if products_with_packages %}
                            {% for item_package in products_with_packages %}
                            {% set product_p = item_package.product %}
                            {% set product_package = item_package.packages %}
                                {% if product_p.uid == product.uid %}
                                    {% if product_package %}
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>长(cm)</th>
                                                <th>宽(cm)</th>
                                                <th>高(cm)</th>
                                                <th>重量(g)</th>
                                                <th>描述</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for product in product_package %}
                                            <tr>
                                                <td>{{ product.length }}</td>
                                                <td>{{ product.width }}</td>
                                                <td>{{ product.height }}</td>
                                                <td>{{ product.weight }}</td>
                                                <td>{{ product.description }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    {% else %}
                                    <tr>
                                        <td colspan="5">暂无数据</td>  <!-- 空数据提示 -->
                                    </tr>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>


        <!-- 详情模态框 -->
        <div class="modal fade" id="detailModal{{ loop.index }}" tabindex="-1" aria-labelledby="detailModalLabel{{ loop.index }}" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="detailModalLabel{{ loop.index }}"><strong>产品详情 - {{ product.name }}</strong></h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <!-- 产品图片展示区域 -->
                            <div class="col-md-6">
                                <h5><strong>产品图片</strong></h5>
                                <div class="overflow-y-auto" style="max-height: 500px; min-height: 200px; padding-right: 8px;">
                                {% if product_images %}
                                    {% for image in product_images %}
                                        <div class="mb-3 position-relative">
                                            <img src="{{ url_for('uploaded_file', filename=image.image_url, product_uid = product.uid) }}" class="img-fluid rounded" alt="产品图片" style="max-height: 200px; object-fit: contain;">
                                            <div class="position-absolute top-0 end-0 m-2 d-flex flex-column align-items-end">
                                                {% if session.is_admin or product.developer_id == session.user_id %}
                                                    <!-- 删除按钮（有权限时显示） -->
                                                    <button type="button"
                                                            class="btn btn-danger btn-sm mb-2"
                                                            onclick="deleteImage({{ image.id }})"
                                                            title="删除图片">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                {% endif %}

                                                <!-- 下载按钮（始终显示） -->
                                                <button type="button" class="btn btn-info btn-sm">
                                                    <a href="{{ url_for('download_file', file_id=image.id, file_type='image', product_uid=image.product_uid) }}"
                                                       style="text-decoration: none; color: inherit;">
                                                        <i class="fas fa-download"></i> 下载
                                                    </a>
                                                </button>

                                                <!-- 复制链接按钮（始终显示） -->
                                                <button type="button"
                                                        class="btn btn-secondary btn-sm mt-1"
                                                        onclick="copyImageLinkFromEndpoint('/get_image_link/{{ image.id }}')"
                                                        title="复制链接">
                                                    <i class="fas fa-copy"></i> 复制链接
                                                </button>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="d-flex align-items-center justify-content-center" style="height: 200px; background-color: #f8f9fa; color: #6c757d;">
                                        <span class="fs-4">暂无图片</span>
                                    </div>
                                {% endif %}
                                </div>

                                <!-- 添加图片按钮 -->
                                <div class="mt-3">
                                    {% if session.is_admin or product.developer_id == session.user_id %}
                                    <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addImageModal{{ product.uid }}">
                                        <i class="fas fa-plus"></i> 添加图片
                                    </button>
                                    {% endif %}
                                    <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal">
                                        <a href="{{ url_for('download_file', file_id = 0, file_type='all_image', product_uid=product.uid) }}"
                                                       style="text-decoration: none; color: inherit;">
                                                        <i class="fas fa-download"></i> 下载所有图片
                                                    </a>
                                    </button>
                                </div>

                                <h5><strong>产品附件</strong></h5>
                                {% if products_with_files %}
                                    {% for product_file in products_with_files %}
                                        {% if product_file.product_uid == product.uid %}
                                        <dt class="col-sm-12 d-flex align-items-center">
                                            <span class="me-auto text-truncate"
                                                  style="max-width: calc(100% - 180px);"
                                                  title="{{ product_file.original_filename }}">
                                                {{ product_file.original_filename }}
                                            </span>
                                            {% if session.is_admin or product.developer_id == session.user_id %}
                                            <button type="button"
                                                    class="btn btn-danger btn-sm me-2"
                                                    onclick="deleteFile({{ product_file.id }})"
                                                    title="删除文件">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% endif %}
                                            <button type="button" class="btn btn-info btn-sm me-2" data-bs-toggle="modal">
                                                <a href="{{ url_for('download_file', file_id=product_file.id, file_type='file', product_uid=product.uid) }}" style="text-decoration: none; color: inherit;">
                                                    <i class="fas fa-download"></i> 下载
                                                </a>
                                            </button>
                                        </dt>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <div class="d-flex align-items-center justify-content-center" style="height: 200px; background-color: #f8f9fa; color: #6c757d;">
                                        <span class="fs-4">暂无文件</span>
                                    </div>
                                {% endif %}

                                <!-- 添加附件按钮 -->
                                <div class="mt-3">
                                    {% if session.is_admin or product.developer_id == session.user_id %}
                                    <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addFileModal{{ product.uid }}">
                                        <i class="fas fa-plus"></i> 添加模型文件
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                            <!-- 产品详细信息 -->
                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-4">产品名称</dt>
                                    <dd class="col-sm-8">{{ product.name }}</dd>

                                    {% if product.short_name %}
                                    <dt class="col-sm-4">短名称</dt>
                                    <dd class="col-sm-8">{{ product.short_name }}</dd>
                                    {% endif %}

                                    <dt class="col-sm-4">SKU</dt>
                                    <dd class="col-sm-8">{{ product.sku }}</dd>

                                    {% if product_3D_weight %}
                                        {% for product_weight in product_3D_weight %}
                                            {% if product_weight.product_uid == product.uid %}
                                                {% if product_weight.danse != 0 %}
                                                <dt class="col-sm-4">单色重量</dt>
                                                <dd class="col-sm-8">{{ product_weight.danse }}g</dd>
                                                {% endif %}

                                                {% if product_weight.duose != 0 %}
                                                <dt class="col-sm-4">多色重量</dt>
                                                <dd class="col-sm-8">{{ product_weight.duose }}g</dd>
                                                {% endif %}

                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}

                                    <dt class="col-sm-4">成本</dt>
                                    <dd class="col-sm-8">¥{{ "%.2f"|format(product.cost) }}</dd>

                                    <dt class="col-sm-4">分类</dt>
                                    <dd class="col-sm-8">{{ product.category }}</dd>

                                    {% if user_list %}
                                        {% for user in user_list %}
                                        {% set user_id = user.user_id %}
                                        {% set username = user.username %}
                                            {% if user_id == product.developer_id %}
                                            <dt class="col-sm-4">开发者</dt>
                                            <dd class="col-sm-8">{{ username }}</dd>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}

                                    <dt class="col-sm-4">UID</dt>
                                    <dd class="col-sm-8">{{ product.uid }}</dd>

                                    {% if permission_list %}
                                        {% for permission in permission_list %}
                                            {% if permission.group_id == product.permission_group_id %}
                                            <dt class="col-sm-4">权限组</dt>
                                            <dd class="col-sm-8">{{ permission.group_name }}</dd>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}

                                    <dt class="col-sm-4">创建时间</dt>
                                    <dd class="col-sm-8">{{ product.created_at }}</dd>

                                    <dt class="col-sm-4">更新时间</dt>
                                    <dd class="col-sm-8">{{ product.updated_at }}</dd>

                                    {% if products_with_packages %}
                                        {% for item_package in products_with_packages %}
                                        {% set product_p = item_package.product %}
                                        {% set product_package = item_package.packages %}
                                            {% if product_p.uid == product.uid %}
                                                {% if product_package %}
                                                <dd class="col-sm-3"><b>长cm</b><br>{{ product_package[0].length }}</dd>
                                                <dd class="col-sm-3"><b>宽cm</b><br>{{ product_package[0].width }}</dd>
                                                <dd class="col-sm-3"><b>高cm</b><br>{{ product_package[0].height }}</dd>
                                                <dd class="col-sm-3"><b>重量g</b><br>{{ product_package[0].weight }}</dd>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </dl>
                                <!-- 新增链接按钮 -->
                                <div class="mt-3">
                                    <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addLinkModal{{ product.uid }}">
                                        <i class="fas fa-plus"></i> 新增链接
                                    </button>
                                    <button type="button" class="btn btn-success btn-sm">
                                        <i class="fas"></i> <a class="av-link" href="{{ url_for('product_links')}}?product_uid={{ product.uid }}" target="_blank" style="color: white; text-decoration: none;">查看已上架链接({{ product_link_count[product.uid] or '0'}}条)</a>
                                    </button>
                                </div>
                                <!-- 新增包装规格按钮 -->
                                <div class="mt-3">
                                    <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addPackageModal{{ product.uid }}">
                                        <i class="fas fa-plus"></i> 新增包装规格
                                    </button>
                                    <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#showPackageModal{{ product.uid }}">
                                        <i class="fas"></i> 查看所有包装规格
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a href="{{ url_for('get_lingxing_excel_jump', uid=product.uid) }}" target="_blank" onclick="return startDownload(event, {{product.uid}})" class="btn btn-primary">导出领星表格</a>
                        {% if session.is_admin or product.developer_id == session.user_id %}
                        <a href="{{ url_for('edit_product', uid=product.uid) }}" class="btn btn-primary">修改产品</a>
                        {% endif %}
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="col-12">
            <p class="text-muted">暂无产品数据</p>
        </div>
    {% endif %}
</div>

<!-- 分页导航 -->
{% if total_pages > 1 %}
<nav aria-label="产品分页">
    <ul class="pagination justify-content-center">
        {% if page > 1 %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('products', page=1, search=search_term, category=category) }}" aria-label="首页">
                <i class="fas fa-angle-double-left"></i>
            </a>
        </li>
        <li class="page-item">
            <a class="page-link" href="{{ url_for('products', page=page-1, search=search_term, category=category) }}" aria-label="上一页">
                <i class="fas fa-angle-left"></i>
            </a>
        </li>
        {% endif %}

        {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
            <li class="page-item active" aria-current="page">
                <span class="page-link">{{ p }}</span>
            </li>
            {% else %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('products', page=p, search=search_term, category=category) }}">{{ p }}</a>
            </li>
            {% endif %}
        {% endfor %}

        {% if page < total_pages %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('products', page=page+1, search=search_term, category=category) }}" aria-label="下一页">
                <i class="fas fa-angle-right"></i>
            </a>
        </li>
        <li class="page-item">
            <a class="page-link" href="{{ url_for('products', page=total_pages, search=search_term, category=category) }}" aria-label="末页">
                <i class="fas fa-angle-double-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // 为每个产品卡片设置对应的产品UID，以便在模态框中获取详细信息
    document.addEventListener('DOMContentLoaded', function() {
        // 获取所有查看详情按钮
        var detailButtons = document.querySelectorAll('[data-bs-target^="#detailModal"]');
        detailButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                var modalId = this.getAttribute('data-bs-target');
                var index = modalId.match(/\d+/)[0]; // 提取模态框的索引
                // 这里假设每个模态框对应一个产品，您可能需要通过AJAX获取详细信息
                // 目前，模态框内容在模板中静态生成，因此无需额外JS
            });
        });
    });
    // 删除图片的函数
    function deleteImage(image_id) {
        if (confirm('确定要删除这张图片吗？')) {
            fetch(`/delete_image/${image_id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    return response.json().then(err => { throw err; }); // 尝试解析错误信息
                }
            })
            .then(data => {
                alert(data.success || '图片已成功删除！'); // 显示成功信息
                location.reload();  // 刷新页面以更新图片列表
            })
            .catch(error => {
                console.error('Error:', error);
                if (error && error.error) {
                    alert(error.error); // 显示后端返回的错误信息
                } else {
                    alert('删除图片失败，请重试！');
                }
            });
        }
    }

    // 删除文件的函数
    function deleteFile(file_id) {
        if (confirm('确定要删除这张图片吗？')) {
            fetch(`/delete_file/${file_id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    return response.json().then(err => { throw err; }); // 尝试解析错误信息
                }
            })
            .then(data => {
                alert(data.success || '图片已成功删除！'); // 显示成功信息
                location.reload();  // 刷新页面以更新图片列表
            })
            .catch(error => {
                console.error('Error:', error);
                if (error && error.error) {
                    alert(error.error); // 显示后端返回的错误信息
                } else {
                    alert('删除图片失败，请重试！');
                }
            });
        }
    }
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('uploadForm1').addEventListener('submit', function (e) {
            var myModal = new bootstrap.Modal(document.getElementById('loadingModal1'));
            myModal.show();
        });

        document.getElementById('uploadForm2').addEventListener('submit', function (e) {
            var myModal = new bootstrap.Modal(document.getElementById('loadingModal2'));
            myModal.show();
        });
    });
</script>
<script>
// 通过 AJAX 调用 /get_image_link获取链接，然后复制
function copyImageLinkFromEndpoint(endpointUrl) {
    fetch(endpointUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error('网络请求失败: ' + response.status);
            }
            // 因为你的视图直接返回文本（如 https://...），不是 JSON
            return response.text();
        })
        .then(imageUrl => {
            // 现在我们得到了真实的图片链接，比如 https://cdn.xxx.com/xxx.jpg
            performCopy(imageUrl);
        })
        .catch(error => {
            console.error('获取图片链接失败:', error);
            showToast('复制失败：无法获取链接', 'error');
        });
}

// 执行复制到剪贴板的通用函数
function performCopy(text) {
    if (navigator.clipboard && window.isSecureContext) {
        // 现代浏览器 Clipboard API
        navigator.clipboard.writeText(text)
            .then(() => {
                showToast('链接已复制到剪贴板！', 'success');
            })
            .catch(err => {
                console.error('Clipboard API 复制失败:', err);
                fallbackCopyTextToClipboard(text);
            });
    } else {
        // 降级方案：兼容老浏览器
        fallbackCopyTextToClipboard(text);
    }
}

// 传统方式复制（兼容老浏览器）
function fallbackCopyTextToClipboard(text) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();

    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showToast('链接已复制到剪贴板！', 'success');
        } else {
            showToast('复制失败，请手动复制', 'error');
        }
    } catch (err) {
        console.error('传统复制方法失败:', err);
        showToast('复制失败，请手动复制', 'error');
    }

    document.body.removeChild(textarea);
}

// 简单的提示函数
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.position = 'fixed';
    toast.style.top = '5%';
    toast.style.left = '50%';
    toast.style.transform = 'translate(-50%, -50%)';
    toast.style.padding = '10px 20px';
    toast.style.borderRadius = '4px';
    toast.style.color = 'white';
    toast.style.zIndex = '9999';
    toast.style.fontSize = '14px';
    toast.style.fontWeight = 'bold';

    // 根据类型设置背景色
    switch (type) {
        case 'success':
            toast.style.backgroundColor = '#28a745'; // 绿色
            break;
        case 'error':
            toast.style.backgroundColor = '#dc3545'; // 红色
            break;
        default:
            toast.style.backgroundColor = '#17a2b8'; // 蓝色
    }

    document.body.appendChild(toast);
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 3000);
}
function startDownload(event, uid) {
    // 阻止 <a> 的默认跳转行为
    event.preventDefault();

    // 用 window.open 打开（关键！这样才可以用 close）
    var downloadWin = window.open('/get_lingxing_excel_Jump/' + uid, '_blank');

    // 可选：如果需要反馈状态，可以在这里设置
    // downloadWin.focus(); // 聚焦新窗口

    return false; // 双重保险，阻止默认行为
}
</script>
{% endblock %}