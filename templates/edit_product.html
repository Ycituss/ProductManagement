{% extends "base.html" %}

{% block title %}修改产品 - 电商产品管理系统{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-edit"></i> 修改产品</h2>
</div>

<div class="card">
    <div class="card-body">
        <form id="uploadForm" method="POST" enctype="multipart/form-data">
            <!-- 产品UID (只读) -->
            <div class="mb-3">
                <label for="uid" class="form-label">产品UID</label>
                <input type="text" class="form-control" id="uid" name="uid" value="{{ product.uid }}" required readonly>
                <div class="form-text">系统自动生成，不可更改</div>
            </div>

            <!-- 产品名称 -->
            <div class="mb-3">
                <label for="name" class="form-label">产品名称 *</label>
                <input type="text" class="form-control" id="name" name="name" value="{{ product.name }}" required>
            </div>

            <!-- 短名称 -->
            <div class="mb-3">
                <label for="short_name" class="form-label">简称</label>
                <input type="text" class="form-control" id="short_name" name="short_name" value="{{ product.short_name or '' }}">
            </div>

            <!-- SKU -->
            <div class="mb-3">
                <label for="sku" class="form-label">SKU *</label>
                <input type="text" class="form-control" id="sku" name="sku" value="{{ product.sku }}" required>
                <div class="form-text">产品的唯一库存单位标识</div>
            </div>

            <!-- 单色重量 -->
            <div class="mb-3">
                <label for="danse" class="form-label">单色重量(g) *</label>
                <input type="number" step="0.01" class="form-control" id="danse" name="danse" value="0" required>
            </div>

            <!-- 多色重量 -->
            <div class="mb-3">
                <label for="duose" class="form-label">多色重量(g) *</label>
                <input type="number" step="0.01" class="form-control" id="duose" name="duose"  value="0" required>
            </div>

            <!-- 成本 -->
            <div class="mb-3">
                <label for="cost" class="form-label">成本 *</label>
                <input type="number" step="0.01" class="form-control" id="cost" name="cost" value="{{ product.cost }}" required>
            </div>

            <!-- 分类 -->
            <div class="mb-3">
                <label for="category" class="form-label">分类 *</label>
                <input type="text" class="form-control" id="category" name="category" value="{{ product.category }}" required>
            </div>

            <!-- 权限组 -->
            <div class="mb-3">
                <label for="permission_group_id" class="form-label">权限组</label>
                <select class="form-select" id="permission_group_id" name="permission_group_id">
                    {% for group in permission_groups %}
                    <option value="{{ group.group_id }}" {% if group.group_id == product.permission_group_id %}selected{% endif %}>
                        {{ group.group_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- 图片上传 -->
            <div class="mb-3">
                <label for="images" class="form-label">产品图片</label>
                <input type="file" class="form-control" id="images" name="images" multiple accept="image/*">
                <div class="form-text">可上传多张图片，仅支持 PNG, JPG, JPEG, GIF 格式。已上传的图片不会被删除，除非手动管理。</div>
            </div>

            <!-- 提交按钮 -->
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">保存修改</button>
                <a href="{{ url_for('products') }}" class="btn btn-outline-secondary">取消</a>
            </div>
        </form>
    </div>
</div>
<!-- 加载中模态框 -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-body text-center">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">上传中...</span>
        </div>
        <p class="mt-2">正在上传图片，请稍候...</p>
      </div>
    </div>
  </div>
</div>
<script>
function getWeight() {
    {% if product_3D_weight %}
        {% for weight in product_3D_weight %}
            {% if weight.product_uid == product.uid %}
                document.getElementById('duose').value = {{ weight.duose }};
                document.getElementById('danse').value = {{ weight.danse }};
            {% endif %}
        {% endfor %}
    {% endif %}
}

// 计算成本的函数
function calculateCost() {
    // 获取输入值（默认为0）
    const danse = parseFloat(document.getElementById('danse').value) || 0;
    const duose = parseFloat(document.getElementById('duose').value) || 0;

    // 计算成本：单色×0.15 + 多色×0.2
    const cost = danse * 0.15 + duose * 0.2;

    // 保留2位小数
    if (cost !== 0) {
        document.getElementById('cost').value = cost.toFixed(2);
    }
}

// 监听输入变化（keyup和change事件覆盖所有输入方式）
document.getElementById('danse').addEventListener('input', calculateCost);
document.getElementById('duose').addEventListener('input', calculateCost);

// 页面加载时计算一次（处理默认值0的情况）
window.onload = calculateCost;

// 页面加载时计算一次
window.onload = getWeight();

document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('uploadForm').addEventListener('submit', function (e) {
        var myModal = new bootstrap.Modal(document.getElementById('loadingModal'));
        myModal.show();
    });
});
</script>
{% endblock %}