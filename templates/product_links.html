{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>产品链接查询</h2>

    <!-- 筛选表单 -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">筛选条件</h5>
    </div>
    <div class="card-body">
        <form method="get" action="{{ url_for('product_links') }}" class="row g-3">
            <!-- 平台 -->
            <div class="col-md-2">
                <label for="platform" class="form-label">平台</label>
                <input type="text" class="form-control" id="platform" name="platform" value="{{ request.args.get('platform', '') }}" placeholder="输入平台">
            </div>
            <!-- 店铺 -->
            <div class="col-md-2">
                <label for="shop" class="form-label">店铺</label>
                <input type="text" class="form-control" id="shop" name="shop" value="{{ request.args.get('shop', '') }}" placeholder="输入店铺">
            </div>
            <!-- 上架日期范围 -->
            <div class="col-md-2">
                <label for="start_date" class="form-label">起始日期</label>
                <input type="date" class="form-control" id="start_date" name="start_date" value="{{ request.args.get('start_date', '') }}">
            </div>
            <div class="col-md-2">
                <label for="end_date" class="form-label">结束日期</label>
                <input type="date" class="form-control" id="end_date" name="end_date" value="{{ request.args.get('end_date', '') }}">
            </div>
            <!-- 价格范围 -->
            <div class="col-md-2">
                <label for="min_price" class="form-label">最低价格</label>
                <input type="number" step="0.01" class="form-control" id="min_price" name="min_price" value="{{ request.args.get('min_price', '') }}" placeholder="最低价格">
            </div>
            <div class="col-md-2">
                <label for="max_price" class="form-label">最高价格</label>
                <input type="number" step="0.01" class="form-control" id="max_price" name="max_price" value="{{ request.args.get('max_price', '') }}" placeholder="最高价格">
            </div>
            <!-- 平台 SKU -->
            <div class="col-md-2">
                <label for="platform_skc" class="form-label">平台 SKU</label>
                <input type="text" class="form-control" id="platform_skc" name="platform_skc" value="{{ request.args.get('platform_skc', '') }}" placeholder="输入 SKU">
            </div>
            <!-- 链接绑定的产品 UID -->
<!--            <div class="col-md-2">-->
<!--                <label for="product_uid" class="form-label">产品 UID</label>-->
<!--                <input type="text" class="form-control" id="product_uid" name="product_uid" value="{{ request.args.get('product_uid', '') }}" placeholder="输入产品 UID">-->
<!--            </div>-->
            <!-- 上架人 -->
            <div class="col-md-2">
                <label for="listed_by" class="form-label">上架人</label>
                <input type="number" class="form-control" id="listed_by" name="listed_by" value="{{ request.args.get('listed_by', '') }}" placeholder="用户ID">
            </div>

            <!-- 排序字段 -->
            <div class="col-md-2">
                <label for="sort_field" class="form-label">排序字段</label>
                <select class="form-control" id="sort_field" name="sort_field">
                    <option value="created_at" {{ 'selected' if request.args.get('sort_field', '') == 'created_at' else '' }}>创建日期</option>
                    <option value="price" {{ 'selected' if request.args.get('sort_field', '') == 'price' else '' }}>价格</option>
                </select>
            </div>

            <!-- 排序顺序 -->
            <div class="col-md-2">
                <label for="sort_order" class="form-label">排序顺序</label>
                <select class="form-control" id="sort_order" name="sort_order">
                    <option value="DESC" {{ 'selected' if request.args.get('sort_order', '') == 'DESC' else '' }}>降序</option>
                    <option value="ASC" {{ 'selected' if request.args.get('sort_order', '') == 'ASC' else '' }}>升序</option>
                </select>
            </div>

            <!-- 提交按钮 -->
            <div class="col-12 mt-3">
                <button type="submit" class="btn btn-primary">筛选</button>
                <a href="{{ url_for('product_links') }}" class="btn btn-secondary ms-2">重置</a>
            </div>
        </form>
    </div>
</div>

    <!-- 链接列表 -->
    <div class="row">
        {% for link in product_links %}
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        {% if link.product_name %}
                            {{ link.product_name }} 的链接
                        {% else %}
                            未关联产品
                        {% endif %}
                    </h5>
                    <!-- 修改链接模态框 -->
                    <div class="modal fade" id="editLinkModal{{ link.id }}" tabindex="-1" aria-labelledby="editLinkModalLabel{{ link.id }} aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editLinkModalLabel{{ link.id }}">新增链接</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <!-- 表单 -->
                                    <form action="{{ url_for('edit_link', link_id=link.id) }}" method="post">
                                        <!-- 隐藏字段：当前产品的 UID -->
                                        <input type="hidden" name="edit_product_uid" value="{{ product_links.product_uid }}">

                                        <input type="hidden" name="edit_id" value="{{ product_links.id }}">


                                        <div class="mb-3">
                                            <label for="edit_platform" class="form-label">平台 *</label>
                                            <input type="text" class="form-control" id="edit_platform" name="edit_platform" value="{{ link.platform }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="edit_shop" class="form-label">店铺 *</label>
                                            <input type="text" class="form-control" id="edit_shop" name="edit_shop" value="{{ link.shop }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="edit_listing_time" class="form-label">上架时间 *</label>
                                            <input type="datetime-local" class="form-control" id="edit_listing_time" name="edit_listing_time" value="{{ link.listing_time }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="edit_title" class="form-label">标题 *</label>
                                            <input type="text" class="form-control" id="edit_title" name="edit_title" value="{{ link.title }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="edit_link_type" class="form-label">链接类型 *</label>
                                            <input type="text" class="form-control" id="edit_link_type" name="edit_link_type" value="{{ link.link_type }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="edit_price_type" class="form-label">价格类型 *</label>
                                            <select class="form-control" id="edit_price_type" name="edit_price_type" value="{{ link.price_type }}" required>
                                                <option value="supply">供应价</option>
                                                <option value="sale">销售价</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="edit_price" class="form-label">价格 *</label>
                                            <input type="number" step="0.01" class="form-control" id="edit_price" name="edit_price" value="{{ link.price }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="edit_platform_skc" class="form-label">平台 SPU *</label>
                                            <input type="text" class="form-control" id="edit_platform_skc" name="edit_platform_skc" value="{{ link.platform_skc }}" required>
                                        </div>
                                        <div class="d-flex justify-content-end">
                                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">取消</button>
                                            <button type="submit" class="btn btn-primary">提交</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p class="card-text"><strong>平台：</strong>{{ link.platform }}</p>
                    <p class="card-text"><strong>店铺：</strong>{{ link.shop }}</p>
                    <p class="card-text"><strong>上架时间：</strong>{{ link.listing_time }}</p>
                    <p class="card-text"><strong>标题：</strong>{{ link.title }}</p>
                    <p class="card-text"><strong>链接类型：</strong>{{ link.link_type }}</p>
                    <p class="card-text"><strong>价格类型：</strong>{{ link.price_type }}</p>
                    <p class="card-text"><strong>价格：</strong>¥{{ "%.2f"|format(link.price) }}</p>
                    {% if link.platform_skc %}
                        <p class="card-text"><strong>平台 SPU：</strong>{{ link.platform_skc }}</p>
                    {% endif %}
                    <p class="card-text"><strong>上架人：</strong>{{ link.listed_by }}</p>
                    <p class="card-text"><strong>创建时间：</strong>{{ link.created_at }}</p>
                    <!-- 删除和编辑按钮（仅对管理员和上架人显示） -->
                    {% if session.is_admin or link.listed_by == session.username %}
                    <div class="mt-3">
                        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#editLinkModal{{ link.id }}">
                            <i class="fas fa-edit"></i> 修改
                        </button>
                        <form action="{{ url_for('delete_link', link_id=link.id) }}" method="post" style="display: inline;">
                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('确定要删除这个链接吗？');">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </form>
                    </div>
                    {% endif %}

                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-center" style="height: 200px; background-color: #f8f9fa; color: #6c757d;">
                <span class="fs-4">暂无链接数据</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}